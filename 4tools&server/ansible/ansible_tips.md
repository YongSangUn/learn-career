# ansible

## 安装

- 安装 epel 源

阿里开源镜像站：  
https://opsx.alibaba.com/mirror/search?q=ep&lang=zh-CN

```shell
$ rpm -Uvh https://mirrors.aliyun.com/epel/epel-release-latest-7.noarch.rpm
$ yum repolist
```

```dns
- 报错信息：
Errno 14] curl#6 - "Could not resolve host: mirrors.aliyun.com; Unknown error"

- 解决办法
$ vi /etc/resolv.conf
# Generated by NetworkManager
nameserver 8.8.8.8
nameserver 114.114.114.114
```

- 通过git安装

```bash
git clone https://github.com/ansible/ansible.git
cd ./ansible
source ./hacking/env-setup

#如果您尚未pip安装Python版本，请安装它：
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python get-pip.py --user

#默认清单文件将为   /etc/ansible/hosts

# argcomplete
sudo yum install epel-release
sudo yum install python-argcomplete
```

## ssh使用密钥进行验证

```bash
$ ssh-keygen        # 生成密钥
$ ssh-keygen -f /testdir/test/id_rsa        # 指定位置和名称。
$ ssh -i /testdir/id_rsa_zsy_testkey zsy@192.168.50.50

# -i 参数可以指定对应的密钥。
$ ssh-keygen -P '123456' -f /testdir/test/id_rsa
$ ssh-keygen -t rsa -b 1024 -P '' -f /testdir/test/id_rsa

# ssh-copy-id为复制命令
# -i 参数为指定文件
# 最终传输到目标机器的 ~/.ssh/authorized_keys 文件中
$ ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.17.101
# 等同于下面的命令
$ cat ~/.ssh/id_rsa.pub | ssh -p 22 zsy@10.1.0.3 "umask 077;mkdir -p ~/.ssh;cat - >> ~/.ssh/authorized_keys"

# 本质上和复制文件没有区别，但是如果目标机器没有创建相应的文件和文件夹，则需要手动创建，且权限容易设置错误。
$ ssh-copy-id -i ~/.ssh/id_rsa.pub user@192.168.17.101 -p 12345
```

1. `$ ssh-keygen -t dsa -P ''`
2. `$ ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.17.101`
3. 编辑 /etc/ansible/hosts 的内容，最后新加一行：  
`test101 ansible_host=192.168.17.101 ansible_port=22`  

## 指定清单文件

export ANSIBLE_INVENTORY=~/ansible_hosts

## 模块基本使用

- ping

```ansible
ansible-doc -l      # 查看所有模块
ansible-doc -s ping         # -s 查看详细命令
ansible testA -m ping       # 测试 testA 组网络是否连通。
```

- fetch (file from remote nodes,从受主主机拉取文件)

```ansible
# 可使用的参数为
dest、fail_on_missing 、flat、src、validate_checksum，

# 其中 src(the file on the remote systen to fetch.) 和 dest(a directory to save to file into.) 是必须的。
ansile testA -m fetch -a "src=/etc/fstab dest=/testdir/ansible/"
```

- 最后的执行状态：
  - 绿色："changed" 为 false, 表示 ansible 没有进行任何操作， 没有改变。
  - 黄色："changed" 为 true, 表示 ansible 执行了操作，“当前状态”已被 ansible 改变成“目标状态”
  - 红色：执行失败。

## 常用模块之文件操作

- copy 模块 （将 ansible 主机上的文件拷贝到远程主机。）

```ansible
src：指定需要 copy 的文件或目录。
dest：执行将被拷贝到远程主机的哪个目录中。
content：不适用 src 指定文件时，可以使用 content 直接指定文件内容，src 与content 连个参数必有其一。
forece：同名是否覆盖
backup：同名是否备份
owner：指定拷贝后的属主，但是必须有指定的用户
group：指定拷贝后的属组，同上。
mode：指定拷贝后的权限，使用，mode=0644（rw-r--r--）。

ansile test -m copy -a "src=/test/testfile dest=/opt/ backup=yes owner=yes mode=0640"
```

- file 模块（对文件的基本操作，对目录执行 创建、删除、修改权限等）

```ansible
path：
